---
title: Runtime
description: API reference for the runtime package
---

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# runtime

```go
import "github.com/eljojo/nara/runtime"
```

## Index

- [Variables](<#variables>)
- [func AllBehaviors\(\) map\[string\]\*Behavior](<#AllBehaviors>)
- [func ClearBehaviors\(\)](<#ClearBehaviors>)
- [func ClearRegistry\(\)](<#ClearRegistry>)
- [func ComputeID\(msg \*Message\) string](<#ComputeID>)
- [func PayloadTypeOf\[T any\]\(\) reflect.Type](<#PayloadTypeOf>)
- [func Register\(b \*Behavior\) error](<#Register>)
- [func TypedHandler\[T any\]\(fn func\(\*Message, \*T\)\) any](<#TypedHandler>)
- [func WithPayloadType\[T any\]\(\) reflect.Type](<#WithPayloadType>)
- [type Behavior](<#Behavior>)
  - [func BroadcastEvent\(kind, desc string, priority int, topic string\) \*Behavior](<#BroadcastEvent>)
  - [func Ephemeral\(kind, desc, topic string\) \*Behavior](<#Ephemeral>)
  - [func Local\(kind, desc string\) \*Behavior](<#Local>)
  - [func Lookup\(kind string\) \*Behavior](<#Lookup>)
  - [func MeshRequest\(kind, desc string\) \*Behavior](<#MeshRequest>)
  - [func Protocol\(kind, desc, topic string\) \*Behavior](<#Protocol>)
  - [func ProtocolUnverified\(kind, desc, topic string\) \*Behavior](<#ProtocolUnverified>)
  - [func StoredEvent\(kind, desc string, priority int\) \*Behavior](<#StoredEvent>)
  - [func \(b \*Behavior\) WithContentKey\(fn func\(any\) string\) \*Behavior](<#Behavior.WithContentKey>)
  - [func \(b \*Behavior\) WithFilter\(stage Stage\) \*Behavior](<#Behavior.WithFilter>)
  - [func \(b \*Behavior\) WithHandler\(version int, fn any\) \*Behavior](<#Behavior.WithHandler>)
  - [func \(b \*Behavior\) WithPayload\(t reflect.Type\) \*Behavior](<#Behavior.WithPayload>)
  - [func \(b \*Behavior\) WithRateLimit\(stage Stage\) \*Behavior](<#Behavior.WithRateLimit>)
- [type BehaviorRegistrar](<#BehaviorRegistrar>)
- [type BehaviorRegistry](<#BehaviorRegistry>)
- [type CallRegistry](<#CallRegistry>)
  - [func \(r \*CallRegistry\) Cancel\(id string\)](<#CallRegistry.Cancel>)
  - [func \(r \*CallRegistry\) Register\(id string, ch chan CallResult, timeout time.Duration\)](<#CallRegistry.Register>)
  - [func \(r \*CallRegistry\) Resolve\(inReplyTo string, response \*Message\) bool](<#CallRegistry.Resolve>)
- [type CallResult](<#CallResult>)
- [type ContentKeyDedupeStage](<#ContentKeyDedupeStage>)
  - [func \(s \*ContentKeyDedupeStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#ContentKeyDedupeStage.Process>)
- [type ContentKeyStage](<#ContentKeyStage>)
  - [func \(s \*ContentKeyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#ContentKeyStage.Process>)
- [type ContentKeyStoreStage](<#ContentKeyStoreStage>)
  - [func \(s \*ContentKeyStoreStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#ContentKeyStoreStage.Process>)
- [type CustomVerifyStage](<#CustomVerifyStage>)
  - [func \(s \*CustomVerifyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#CustomVerifyStage.Process>)
- [type DefaultSignStage](<#DefaultSignStage>)
  - [func \(s \*DefaultSignStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#DefaultSignStage.Process>)
- [type DefaultStoreStage](<#DefaultStoreStage>)
  - [func \(s \*DefaultStoreStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#DefaultStoreStage.Process>)
- [type DefaultVerifyStage](<#DefaultVerifyStage>)
  - [func \(s \*DefaultVerifyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#DefaultVerifyStage.Process>)
- [type EmitBehavior](<#EmitBehavior>)
- [type Environment](<#Environment>)
- [type ErrorStrategy](<#ErrorStrategy>)
- [type EventBusInterface](<#EventBusInterface>)
- [type GossipQueueInterface](<#GossipQueueInterface>)
- [type GossipStage](<#GossipStage>)
  - [func \(s \*GossipStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#GossipStage.Process>)
- [type IDDedupeStage](<#IDDedupeStage>)
  - [func \(s \*IDDedupeStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#IDDedupeStage.Process>)
- [type IDStage](<#IDStage>)
  - [func \(s \*IDStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#IDStage.Process>)
- [type ImportanceFilterStage](<#ImportanceFilterStage>)
  - [func \(s \*ImportanceFilterStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#ImportanceFilterStage.Process>)
- [type KeypairInterface](<#KeypairInterface>)
- [type LedgerInterface](<#LedgerInterface>)
- [type Logger](<#Logger>)
- [type MQTTPerNaraStage](<#MQTTPerNaraStage>)
  - [func \(s \*MQTTPerNaraStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#MQTTPerNaraStage.Process>)
- [type MQTTStage](<#MQTTStage>)
  - [func \(s \*MQTTStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#MQTTStage.Process>)
- [type MeshOnlyStage](<#MeshOnlyStage>)
  - [func \(s \*MeshOnlyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#MeshOnlyStage.Process>)
- [type Message](<#Message>)
  - [func \(m \*Message\) Marshal\(\) \[\]byte](<#Message.Marshal>)
  - [func \(m \*Message\) Reply\(kind string, payload any\) \*Message](<#Message.Reply>)
  - [func \(m \*Message\) SignableContent\(\) \[\]byte](<#Message.SignableContent>)
  - [func \(m \*Message\) VerifySignature\(pubKey \[\]byte\) bool](<#Message.VerifySignature>)
- [type MockKeypair](<#MockKeypair>)
  - [func NewMockKeypair\(\) \*MockKeypair](<#NewMockKeypair>)
  - [func \(k \*MockKeypair\) Open\(nonce, ciphertext \[\]byte\) \(\[\]byte, error\)](<#MockKeypair.Open>)
  - [func \(k \*MockKeypair\) PublicKey\(\) \[\]byte](<#MockKeypair.PublicKey>)
  - [func \(k \*MockKeypair\) Seal\(plaintext \[\]byte\) \(nonce, ciphertext \[\]byte, err error\)](<#MockKeypair.Seal>)
  - [func \(k \*MockKeypair\) Sign\(data \[\]byte\) \[\]byte](<#MockKeypair.Sign>)
- [type MockRuntime](<#MockRuntime>)
  - [func NewMockRuntime\(t \*testing.T, name types.NaraName, id types.NaraID\) \*MockRuntime](<#NewMockRuntime>)
  - [func \(m \*MockRuntime\) Clear\(\)](<#MockRuntime.Clear>)
  - [func \(m \*MockRuntime\) Deliver\(msg \*Message\)](<#MockRuntime.Deliver>)
  - [func \(m \*MockRuntime\) Emit\(msg \*Message\) error](<#MockRuntime.Emit>)
  - [func \(m \*MockRuntime\) EmittedCount\(\) int](<#MockRuntime.EmittedCount>)
  - [func \(m \*MockRuntime\) EmittedOfKind\(kind string\) \[\]\*Message](<#MockRuntime.EmittedOfKind>)
  - [func \(m \*MockRuntime\) Env\(\) Environment](<#MockRuntime.Env>)
  - [func \(m \*MockRuntime\) LastEmitted\(\) \*Message](<#MockRuntime.LastEmitted>)
  - [func \(m \*MockRuntime\) Log\(service string\) \*ServiceLog](<#MockRuntime.Log>)
  - [func \(m \*MockRuntime\) LookupPublicKey\(id types.NaraID\) \[\]byte](<#MockRuntime.LookupPublicKey>)
  - [func \(m \*MockRuntime\) LookupPublicKeyByName\(name types.NaraName\) \[\]byte](<#MockRuntime.LookupPublicKeyByName>)
  - [func \(m \*MockRuntime\) Me\(\) \*Nara](<#MockRuntime.Me>)
  - [func \(m \*MockRuntime\) MeID\(\) types.NaraID](<#MockRuntime.MeID>)
  - [func \(m \*MockRuntime\) MemoryMode\(\) string](<#MockRuntime.MemoryMode>)
  - [func \(m \*MockRuntime\) OnlinePeers\(\) \[\]\*PeerInfo](<#MockRuntime.OnlinePeers>)
  - [func \(m \*MockRuntime\) Open\(nonce, ciphertext \[\]byte\) \(\[\]byte, error\)](<#MockRuntime.Open>)
  - [func \(m \*MockRuntime\) RegisterBehavior\(b \*Behavior\)](<#MockRuntime.RegisterBehavior>)
  - [func \(m \*MockRuntime\) RegisterPublicKey\(id types.NaraID, key \[\]byte\)](<#MockRuntime.RegisterPublicKey>)
  - [func \(m \*MockRuntime\) Seal\(plaintext \[\]byte\) \(nonce, ciphertext \[\]byte, err error\)](<#MockRuntime.Seal>)
  - [func \(m \*MockRuntime\) Stop\(\)](<#MockRuntime.Stop>)
  - [func \(m \*MockRuntime\) StorageLimit\(\) int](<#MockRuntime.StorageLimit>)
  - [func \(m \*MockRuntime\) Subscribe\(kind string, handler func\(\*Message\)\)](<#MockRuntime.Subscribe>)
- [type Nara](<#Nara>)
- [type NetworkInfoInterface](<#NetworkInfoInterface>)
- [type NoContentKeyStage](<#NoContentKeyStage>)
  - [func \(s \*NoContentKeyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoContentKeyStage.Process>)
- [type NoFilterStage](<#NoFilterStage>)
  - [func \(s \*NoFilterStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoFilterStage.Process>)
- [type NoGossipStage](<#NoGossipStage>)
  - [func \(s \*NoGossipStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoGossipStage.Process>)
- [type NoSignStage](<#NoSignStage>)
  - [func \(s \*NoSignStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoSignStage.Process>)
- [type NoStoreStage](<#NoStoreStage>)
  - [func \(s \*NoStoreStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoStoreStage.Process>)
- [type NoTransportStage](<#NoTransportStage>)
  - [func \(s \*NoTransportStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoTransportStage.Process>)
- [type NoVerifyStage](<#NoVerifyStage>)
  - [func \(s \*NoVerifyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NoVerifyStage.Process>)
- [type NotifyStage](<#NotifyStage>)
  - [func \(s \*NotifyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#NotifyStage.Process>)
- [type PeerInfo](<#PeerInfo>)
- [type Personality](<#Personality>)
- [type Pipeline](<#Pipeline>)
  - [func \(p Pipeline\) Run\(msg \*Message, ctx \*PipelineContext\) StageResult](<#Pipeline.Run>)
- [type PipelineContext](<#PipelineContext>)
- [type RateLimitStage](<#RateLimitStage>)
  - [func \(s \*RateLimitStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#RateLimitStage.Process>)
- [type ReceiveBehavior](<#ReceiveBehavior>)
- [type Runtime](<#Runtime>)
  - [func NewRuntime\(cfg RuntimeConfig\) \*Runtime](<#NewRuntime>)
  - [func \(rt \*Runtime\) AddService\(svc Service\) error](<#Runtime.AddService>)
  - [func \(rt \*Runtime\) Emit\(msg \*Message\) error](<#Runtime.Emit>)
  - [func \(rt \*Runtime\) Env\(\) Environment](<#Runtime.Env>)
  - [func \(rt \*Runtime\) Log\(service string\) \*ServiceLog](<#Runtime.Log>)
  - [func \(rt \*Runtime\) LookupPublicKey\(id types.NaraID\) \[\]byte](<#Runtime.LookupPublicKey>)
  - [func \(rt \*Runtime\) LookupPublicKeyByName\(name types.NaraName\) \[\]byte](<#Runtime.LookupPublicKeyByName>)
  - [func \(rt \*Runtime\) Me\(\) \*Nara](<#Runtime.Me>)
  - [func \(rt \*Runtime\) MeID\(\) types.NaraID](<#Runtime.MeID>)
  - [func \(rt \*Runtime\) MemoryMode\(\) string](<#Runtime.MemoryMode>)
  - [func \(rt \*Runtime\) OnlinePeers\(\) \[\]\*PeerInfo](<#Runtime.OnlinePeers>)
  - [func \(rt \*Runtime\) Open\(nonce, ciphertext \[\]byte\) \(\[\]byte, error\)](<#Runtime.Open>)
  - [func \(rt \*Runtime\) Receive\(raw \[\]byte\) error](<#Runtime.Receive>)
  - [func \(rt \*Runtime\) RegisterPublicKey\(id types.NaraID, key \[\]byte\)](<#Runtime.RegisterPublicKey>)
  - [func \(rt \*Runtime\) Seal\(plaintext \[\]byte\) \(nonce, ciphertext \[\]byte, err error\)](<#Runtime.Seal>)
  - [func \(rt \*Runtime\) Start\(\) error](<#Runtime.Start>)
  - [func \(rt \*Runtime\) Stop\(\) error](<#Runtime.Stop>)
  - [func \(rt \*Runtime\) StorageLimit\(\) int](<#Runtime.StorageLimit>)
- [type RuntimeConfig](<#RuntimeConfig>)
- [type RuntimeInterface](<#RuntimeInterface>)
- [type SelfAttestingVerifyStage](<#SelfAttestingVerifyStage>)
  - [func \(s \*SelfAttestingVerifyStage\) Process\(msg \*Message, ctx \*PipelineContext\) StageResult](<#SelfAttestingVerifyStage.Process>)
- [type Service](<#Service>)
- [type ServiceLog](<#ServiceLog>)
  - [func \(l \*ServiceLog\) Debug\(format string, args ...any\)](<#ServiceLog.Debug>)
  - [func \(l \*ServiceLog\) Error\(format string, args ...any\)](<#ServiceLog.Error>)
  - [func \(l \*ServiceLog\) Info\(format string, args ...any\)](<#ServiceLog.Info>)
  - [func \(l \*ServiceLog\) Warn\(format string, args ...any\)](<#ServiceLog.Warn>)
- [type Stage](<#Stage>)
  - [func Casual\(filterFunc func\(\*Message, \*Personality\) bool\) Stage](<#Casual>)
  - [func ContentKey\(keyFunc func\(any\) string\) Stage](<#ContentKey>)
  - [func ContentKeyDedupe\(\) Stage](<#ContentKeyDedupe>)
  - [func ContentKeyStore\(priority int\) Stage](<#ContentKeyStore>)
  - [func Critical\(\) Stage](<#Critical>)
  - [func CustomVerify\(verifyFunc func\(\*Message, \*PipelineContext\) StageResult\) Stage](<#CustomVerify>)
  - [func DefaultSign\(\) Stage](<#DefaultSign>)
  - [func DefaultStore\(priority int\) Stage](<#DefaultStore>)
  - [func DefaultVerify\(\) Stage](<#DefaultVerify>)
  - [func Gossip\(\) Stage](<#Gossip>)
  - [func IDDedupe\(\) Stage](<#IDDedupe>)
  - [func MQTT\(topic string\) Stage](<#MQTT>)
  - [func MQTTPerNara\(pattern string\) Stage](<#MQTTPerNara>)
  - [func MeshOnly\(\) Stage](<#MeshOnly>)
  - [func NoContentKey\(\) Stage](<#NoContentKey>)
  - [func NoFilter\(\) Stage](<#NoFilter>)
  - [func NoGossip\(\) Stage](<#NoGossip>)
  - [func NoSign\(\) Stage](<#NoSign>)
  - [func NoStore\(\) Stage](<#NoStore>)
  - [func NoTransport\(\) Stage](<#NoTransport>)
  - [func NoVerify\(\) Stage](<#NoVerify>)
  - [func Normal\(\) Stage](<#Normal>)
  - [func RateLimit\(window time.Duration, max int, keyFunc func\(\*Message\) string\) Stage](<#RateLimit>)
  - [func SelfAttesting\(extractKey func\(any\) \[\]byte\) Stage](<#SelfAttesting>)
- [type StageResult](<#StageResult>)
  - [func Continue\(msg \*Message\) StageResult](<#Continue>)
  - [func Drop\(reason string\) StageResult](<#Drop>)
  - [func Fail\(err error\) StageResult](<#Fail>)
  - [func \(r StageResult\) IsContinue\(\) bool](<#StageResult.IsContinue>)
  - [func \(r StageResult\) IsDrop\(\) bool](<#StageResult.IsDrop>)
  - [func \(r StageResult\) IsError\(\) bool](<#StageResult.IsError>)
- [type TransportInterface](<#TransportInterface>)


## Variables

<a name="EphemeralDefaults"></a>EphemeralDefaults \- not stored, not gossiped, unverified

```go
var EphemeralDefaults = Behavior{
    Emit:    EmitBehavior{Sign: NoSign(), Store: NoStore(), Gossip: NoGossip()},
    Receive: ReceiveBehavior{Verify: NoVerify(), Dedupe: IDDedupe(), Store: NoStore()},
}
```

<a name="LocalDefaults"></a>LocalDefaults \- for service\-to\-service communication within a nara No network transport, no signing, no storage \- just internal event routing

```go
var LocalDefaults = Behavior{
    Emit:    EmitBehavior{Sign: NoSign(), Store: NoStore(), Gossip: NoGossip(), Transport: NoTransport()},
    Receive: ReceiveBehavior{Verify: NoVerify(), Dedupe: IDDedupe(), Store: NoStore()},
}
```

<a name="ProtocolDefaults"></a>ProtocolDefaults \- not stored, not gossiped, verified, critical

```go
var ProtocolDefaults = Behavior{
    Emit:    EmitBehavior{Sign: DefaultSign(), Store: NoStore(), Gossip: NoGossip()},
    Receive: ReceiveBehavior{Verify: DefaultVerify(), Dedupe: IDDedupe(), Store: NoStore(), Filter: Critical()},
}
```

<a name="ProtocolUnverifiedDefaults"></a>ProtocolUnverifiedDefaults \- like Protocol but no signature verification

```go
var ProtocolUnverifiedDefaults = Behavior{
    Emit:    EmitBehavior{Sign: NoSign(), Store: NoStore(), Gossip: NoGossip()},
    Receive: ReceiveBehavior{Verify: NoVerify(), Dedupe: IDDedupe(), Store: NoStore(), Filter: Critical()},
}
```

<a name="StoredDefaults"></a>StoredDefaults \- persisted, gossiped, verified

```go
var StoredDefaults = Behavior{
    Emit:    EmitBehavior{Sign: DefaultSign(), Store: DefaultStore(2), Gossip: Gossip(), Transport: NoTransport()},
    Receive: ReceiveBehavior{Verify: DefaultVerify(), Dedupe: IDDedupe(), Store: DefaultStore(2)},
}
```

<a name="AllBehaviors"></a>
## func [AllBehaviors](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L259>)

```go
func AllBehaviors() map[string]*Behavior
```

AllBehaviors returns a copy of all registered behaviors.

<a name="ClearBehaviors"></a>
## func [ClearBehaviors](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L252>)

```go
func ClearBehaviors()
```

ClearBehaviors clears the global behavior registry \(for testing\).

<a name="ClearRegistry"></a>
## func [ClearRegistry](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L271>)

```go
func ClearRegistry()
```

ClearRegistry clears all registered behaviors \(for testing only\).

<a name="ComputeID"></a>
## func [ComputeID](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L43>)

```go
func ComputeID(msg *Message) string
```

ComputeID generates a unique envelope ID from message content.

The ID is deterministic but always unique per message instance because it includes the timestamp with nanosecond precision.

<a name="PayloadTypeOf"></a>
## func [PayloadTypeOf](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L278>)

```go
func PayloadTypeOf[T any]() reflect.Type
```

PayloadTypeOf is a helper to get reflect.Type from a struct.

<a name="Register"></a>
## func [Register](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L231>)

```go
func Register(b *Behavior) error
```

Register registers a behavior with the global registry.

In tests, re\-registration is allowed \(replaces existing behavior\). In production, behaviors are registered once during startup.

<a name="TypedHandler"></a>
## func [TypedHandler](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L198>)

```go
func TypedHandler[T any](fn func(*Message, *T)) any
```

TypedHandler wraps a typed handler function for the registry.

<a name="WithPayloadType"></a>
## func [WithPayloadType](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L182>)

```go
func WithPayloadType[T any]() reflect.Type
```

WithPayloadType is a generic version of WithPayload.

<a name="Behavior"></a>
## type [Behavior](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L28-L49>)

Behavior defines how a message kind is handled.

Each message kind \(like "stash:store", "checkpoint", "social"\) has a Behavior that declares:

- What payload type to deserialize
- How to process it when emitting \(signing, storage, transport\)
- How to process it when receiving \(verification, dedup, filtering\)
- Version\-specific typed handlers

```go
type Behavior struct {
    // Identity
    Kind        string // Unique identifier, e.g., "observation:restart", "stash:store"
    Description string // Human-readable description

    // Versioning
    CurrentVersion int                  // Version for new messages (default 1)
    MinVersion     int                  // Oldest version still accepted (default 1)
    PayloadTypes   map[int]reflect.Type // Payload type per version (required)

    // Version-specific handlers (typed via TypedHandler helper)
    // Each handler has signature: func(*Message, *PayloadType)
    Handlers map[int]any

    // ContentKey derivation (nil = no content key)
    // Used for cross-observer deduplication (like observations)
    ContentKey func(payload any) string

    // Pipeline stages - split by direction
    Emit    EmitBehavior
    Receive ReceiveBehavior
}
```

<a name="BroadcastEvent"></a>
### func [BroadcastEvent](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L152>)

```go
func BroadcastEvent(kind, desc string, priority int, topic string) *Behavior
```

BroadcastEvent creates a behavior for stored, gossiped, AND broadcast via MQTT.

<a name="Ephemeral"></a>
### func [Ephemeral](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L106>)

```go
func Ephemeral(kind, desc, topic string) *Behavior
```

Ephemeral creates a behavior for ephemeral broadcasts \(no storage, MQTT only\).

<a name="Local"></a>
### func [Local](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L164>)

```go
func Local(kind, desc string) *Behavior
```

Local creates a behavior for service\-to\-service communication within a nara. No network transport, no signing, no storage \- just internal routing.

<a name="Lookup"></a>
### func [Lookup](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L245>)

```go
func Lookup(kind string) *Behavior
```

Lookup finds a behavior by kind.

<a name="MeshRequest"></a>
### func [MeshRequest](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L133>)

```go
func MeshRequest(kind, desc string) *Behavior
```

MeshRequest creates a behavior for protocol messages over mesh \(not MQTT\).

<a name="Protocol"></a>
### func [Protocol](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L115>)

```go
func Protocol(kind, desc, topic string) *Behavior
```

Protocol creates a behavior for protocol messages \(not stored, verified, critical\).

<a name="ProtocolUnverified"></a>
### func [ProtocolUnverified](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L124>)

```go
func ProtocolUnverified(kind, desc, topic string) *Behavior
```

ProtocolUnverified creates a protocol behavior without signature verification.

<a name="StoredEvent"></a>
### func [StoredEvent](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L142>)

```go
func StoredEvent(kind, desc string, priority int) *Behavior
```

StoredEvent creates a behavior for stored, gossiped events \(no MQTT broadcast\).

<a name="Behavior.WithContentKey"></a>
### func \(\*Behavior\) [WithContentKey](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L203>)

```go
func (b *Behavior) WithContentKey(fn func(any) string) *Behavior
```

WithContentKey adds ContentKey derivation to a behavior.

<a name="Behavior.WithFilter"></a>
### func \(\*Behavior\) [WithFilter](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L209>)

```go
func (b *Behavior) WithFilter(stage Stage) *Behavior
```

WithFilter customizes the receive filter.

<a name="Behavior.WithHandler"></a>
### func \(\*Behavior\) [WithHandler](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L189>)

```go
func (b *Behavior) WithHandler(version int, fn any) *Behavior
```

WithHandler adds a typed handler for a specific version. Usage: .WithHandler\(1, service.handleV1\).WithHandler\(2, service.handleV2\)

<a name="Behavior.WithPayload"></a>
### func \(\*Behavior\) [WithPayload](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L174>)

```go
func (b *Behavior) WithPayload(t reflect.Type) *Behavior
```

WithPayload sets the payload type for v1 \(defaults to v1\).

<a name="Behavior.WithRateLimit"></a>
### func \(\*Behavior\) [WithRateLimit](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L215>)

```go
func (b *Behavior) WithRateLimit(stage Stage) *Behavior
```

WithRateLimit adds rate limiting to the receive pipeline.

<a name="BehaviorRegistrar"></a>
## type [BehaviorRegistrar](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L166-L168>)

BehaviorRegistrar is optionally implemented by services that register behaviors.

```go
type BehaviorRegistrar interface {
    RegisterBehaviors(rt RuntimeInterface)
}
```

<a name="BehaviorRegistry"></a>
## type [BehaviorRegistry](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L173-L175>)

BehaviorRegistry is optionally implemented by runtimes that support local behavior registration. The mock runtime implements this to allow per\-runtime behavior registration \(for tests\). The real runtime may delegate to the global registry.

```go
type BehaviorRegistry interface {
    RegisterBehavior(b *Behavior)
}
```

<a name="CallRegistry"></a>
## type [CallRegistry](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L178-L181>)

CallRegistry manages pending Call requests \(Chapter 3\).

```go
type CallRegistry struct {
    // contains filtered or unexported fields
}
```

<a name="CallRegistry.Cancel"></a>
### func \(\*CallRegistry\) [Cancel](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L197>)

```go
func (r *CallRegistry) Cancel(id string)
```



<a name="CallRegistry.Register"></a>
### func \(\*CallRegistry\) [Register](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L188>)

```go
func (r *CallRegistry) Register(id string, ch chan CallResult, timeout time.Duration)
```



<a name="CallRegistry.Resolve"></a>
### func \(\*CallRegistry\) [Resolve](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L192>)

```go
func (r *CallRegistry) Resolve(inReplyTo string, response *Message) bool
```



<a name="CallResult"></a>
## type [CallResult](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L147-L150>)

CallResult is returned by CallAsync \(Chapter 3\).

```go
type CallResult struct {
    Response *Message
    Error    error
}
```

<a name="ContentKeyDedupeStage"></a>
## type [ContentKeyDedupeStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L88>)

ContentKeyDedupeStage rejects messages with duplicate ContentKey \(same fact\).

Used for observations where multiple naras may report the same fact. Different from IDDedupe: same ContentKey, different IDs.

```go
type ContentKeyDedupeStage struct{}
```

<a name="ContentKeyDedupeStage.Process"></a>
### func \(\*ContentKeyDedupeStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L90>)

```go
func (s *ContentKeyDedupeStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="ContentKeyStage"></a>
## type [ContentKeyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L204-L206>)

ContentKeyStage computes the semantic identity for dedup.

Only used for messages that need cross\-observer deduplication \(like observations\).

```go
type ContentKeyStage struct {
    KeyFunc func(payload any) string
}
```

<a name="ContentKeyStage.Process"></a>
### func \(\*ContentKeyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L208>)

```go
func (s *ContentKeyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="ContentKeyStoreStage"></a>
## type [ContentKeyStoreStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L73-L75>)

ContentKeyStoreStage stores with ContentKey\-based deduplication.

Only stores if no message with the same ContentKey exists. Used for observations where multiple naras may report the same fact.

```go
type ContentKeyStoreStage struct {
    Priority int
}
```

<a name="ContentKeyStoreStage.Process"></a>
### func \(\*ContentKeyStoreStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L77>)

```go
func (s *ContentKeyStoreStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="CustomVerifyStage"></a>
## type [CustomVerifyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L55-L57>)

CustomVerifyStage uses a custom verification function.

Used for complex verification like checkpoint multi\-sig.

```go
type CustomVerifyStage struct {
    VerifyFunc func(msg *Message, ctx *PipelineContext) StageResult
}
```

<a name="CustomVerifyStage.Process"></a>
### func \(\*CustomVerifyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L59>)

```go
func (s *CustomVerifyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="DefaultSignStage"></a>
## type [DefaultSignStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L26>)

DefaultSignStage signs the message with the runtime's keypair.

```go
type DefaultSignStage struct{}
```

<a name="DefaultSignStage.Process"></a>
### func \(\*DefaultSignStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L28>)

```go
func (s *DefaultSignStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="DefaultStoreStage"></a>
## type [DefaultStoreStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L54-L56>)

DefaultStoreStage stores the message in the ledger with a GC priority.

Needed for Chapter 2.

```go
type DefaultStoreStage struct {
    Priority int // 0 = never prune, higher = prune sooner
}
```

<a name="DefaultStoreStage.Process"></a>
### func \(\*DefaultStoreStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L58>)

```go
func (s *DefaultStoreStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="DefaultVerifyStage"></a>
## type [DefaultVerifyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L12>)

DefaultVerifyStage verifies the message signature against a known public key.

Looks up the public key by FromID and verifies the signature.

```go
type DefaultVerifyStage struct{}
```

<a name="DefaultVerifyStage.Process"></a>
### func \(\*DefaultVerifyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L14>)

```go
func (s *DefaultVerifyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="EmitBehavior"></a>
## type [EmitBehavior](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L52-L58>)

EmitBehavior defines how outgoing messages are processed.

```go
type EmitBehavior struct {
    Sign      Stage         // How to sign (default: DefaultSign)
    Store     Stage         // How to store (default: DefaultStore(2))
    Gossip    Stage         // Whether to gossip (default: NoGossip)
    Transport Stage         // How to send (required)
    OnError   ErrorStrategy // What to do on failure
}
```

<a name="Environment"></a>
## type [Environment](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L108>)

Environment enum for runtime behavior.

Like Rails environments \- different defaults for different contexts.

```go
type Environment int
```

<a name="EnvProduction"></a>

```go
const (
    EnvProduction  Environment = iota // Graceful: log errors, don't crash
    EnvDevelopment                    // Loud: warnings, fail on suspicious things
    EnvTest                           // Strict: panic on errors, catch bugs early
)
```

<a name="ErrorStrategy"></a>
## type [ErrorStrategy](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L10>)

ErrorStrategy defines how to handle errors at each pipeline stage.

```go
type ErrorStrategy int
```

<a name="ErrorDrop"></a>

```go
const (
    ErrorDrop  ErrorStrategy = iota // Drop message silently
    ErrorLog                        // Log warning and drop
    ErrorRetry                      // Retry with exponential backoff
    ErrorQueue                      // Send to dead letter queue for inspection
    ErrorPanic                      // Fail loudly (for critical messages)
)
```

<a name="EventBusInterface"></a>
## type [EventBusInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L84-L87>)

EventBusInterface is what notification stages use.

```go
type EventBusInterface interface {
    Emit(msg *Message)
    Subscribe(kind string, handler func(*Message))
}
```

<a name="GossipQueueInterface"></a>
## type [GossipQueueInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L63-L65>)

GossipQueueInterface is what gossip stages use.

```go
type GossipQueueInterface interface {
    Add(msg *Message)
}
```

<a name="GossipStage"></a>
## type [GossipStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L108>)

GossipStage explicitly queues the message for gossip.

The gossip service will include this message in zines sent to peers.

```go
type GossipStage struct{}
```

<a name="GossipStage.Process"></a>
### func \(\*GossipStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L110>)

```go
func (s *GossipStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="IDDedupeStage"></a>
## type [IDDedupeStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L75>)

IDDedupeStage rejects messages with duplicate ID \(exact same message\).

This prevents processing the same message twice if received via multiple paths.

```go
type IDDedupeStage struct{}
```

<a name="IDDedupeStage.Process"></a>
### func \(\*IDDedupeStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L77>)

```go
func (s *IDDedupeStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="IDStage"></a>
## type [IDStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L14>)

IDStage computes the unique envelope ID for a message.

This always runs first in the emit pipeline. The ID is deterministic but always unique per message instance \(includes nanosecond timestamp\).

```go
type IDStage struct{}
```

<a name="IDStage.Process"></a>
### func \(\*IDStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L16>)

```go
func (s *IDStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="ImportanceFilterStage"></a>
## type [ImportanceFilterStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L122-L125>)

ImportanceFilterStage filters messages based on importance level and personality.

Importance levels:

- 3 \(Critical\): Never filtered
- 2 \(Normal\): Filtered only if very chill
- 1 \(Casual\): Uses custom filter function

```go
type ImportanceFilterStage struct {
    Importance   int // 1=casual, 2=normal, 3=critical
    CasualFilter func(msg *Message, personality *Personality) bool
}
```

<a name="ImportanceFilterStage.Process"></a>
### func \(\*ImportanceFilterStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L127>)

```go
func (s *ImportanceFilterStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="KeypairInterface"></a>
## type [KeypairInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L75-L81>)

KeypairInterface is what sign stages use.

```go
type KeypairInterface interface {
    Sign(data []byte) []byte
    PublicKey() []byte
    // Encryption (self-encryption using XChaCha20-Poly1305)
    Seal(plaintext []byte) (nonce, ciphertext []byte, err error)
    Open(nonce, ciphertext []byte) ([]byte, error)
}
```

<a name="LedgerInterface"></a>
## type [LedgerInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L50-L54>)

LedgerInterface is what store stages use.

```go
type LedgerInterface interface {
    Add(msg *Message, priority int) error
    HasID(id string) bool
    HasContentKey(contentKey string) bool
}
```

<a name="Logger"></a>
## type [Logger](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L142-L144>)

Logger is the central logging coordinator \(owned by Runtime\).

```go
type Logger struct {
}
```

<a name="MQTTPerNaraStage"></a>
## type [MQTTPerNaraStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L167-L169>)

MQTTPerNaraStage broadcasts to a per\-nara topic.

```go
type MQTTPerNaraStage struct {
    TopicPattern string // e.g., "nara/newspaper/%s"
}
```

<a name="MQTTPerNaraStage.Process"></a>
### func \(\*MQTTPerNaraStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L171>)

```go
func (s *MQTTPerNaraStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="MQTTStage"></a>
## type [MQTTStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L150-L152>)

MQTTStage broadcasts to a fixed MQTT topic.

```go
type MQTTStage struct {
    Topic string
}
```

<a name="MQTTStage.Process"></a>
### func \(\*MQTTStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L154>)

```go
func (s *MQTTStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="MeshOnlyStage"></a>
## type [MeshOnlyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L131>)

MeshOnlyStage sends the message directly via mesh to a specific target.

Fails if the target is unreachable. Used by stash for direct peer communication.

```go
type MeshOnlyStage struct{}
```

<a name="MeshOnlyStage.Process"></a>
### func \(\*MeshOnlyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L133>)

```go
func (s *MeshOnlyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="Message"></a>
## type [Message](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L17-L37>)

Message is the universal primitive for all communication in Nara.

Everything that flows through the system is a Message: stored events, ephemeral broadcasts, protocol exchanges, and internal service communication.

```go
type Message struct {
    // Core identity (always present)
    ID         string         // Unique envelope identifier (always unique per message instance)
    ContentKey string         // Semantic identity for dedup (optional, stable across observers)
    Kind       string         // Message type: "hey-there", "observation:restart", "checkpoint", etc.
    Version    int            // Schema version for this kind (default 1, increment on breaking changes)
    From       types.NaraName // Sender name (for display)
    FromID     types.NaraID   // Sender nara ID (primary identifier)
    To         types.NaraName // Target name (for direct messages, display only)
    ToID       types.NaraID   // Target nara ID (for direct messages, primary identifier)
    Timestamp  time.Time      // When it was created

    // Content
    Payload any // Kind-specific data (Go struct, runtime handles serialization)

    // Cryptographic (attached by runtime)
    Signature []byte // Creator's signature (may be nil for some kinds)

    // Correlation (for Call/response pattern - Chapter 3)
    InReplyTo string // Links response to request (for Call/response pattern)
}
```

<a name="Message.Marshal"></a>
### func \(\*Message\) [Marshal](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L94>)

```go
func (m *Message) Marshal() []byte
```

Marshal serializes the message for network transport.

<a name="Message.Reply"></a>
### func \(\*Message\) [Reply](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L103>)

```go
func (m *Message) Reply(kind string, payload any) *Message
```

Reply creates a response message linked to the original.

Automatically sets InReplyTo, ToID, and swaps the direction. Used for request/response patterns \(Chapter 3\).

<a name="Message.SignableContent"></a>
### func \(\*Message\) [SignableContent](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L61>)

```go
func (m *Message) SignableContent() []byte
```

SignableContent returns the canonical bytes to be signed.

This ensures consistent signing across the network.

<a name="Message.VerifySignature"></a>
### func \(\*Message\) [VerifySignature](<https://github.com/eljojo/nara/blob/main/runtime/message.go#L83>)

```go
func (m *Message) VerifySignature(pubKey []byte) bool
```

VerifySignature checks if the signature is valid for this message.

<a name="MockKeypair"></a>
## type [MockKeypair](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L224-L227>)

MockKeypair is a fake keypair for testing.

```go
type MockKeypair struct {
    // contains filtered or unexported fields
}
```

<a name="NewMockKeypair"></a>
### func [NewMockKeypair](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L230>)

```go
func NewMockKeypair() *MockKeypair
```

NewMockKeypair creates a new mock keypair.

<a name="MockKeypair.Open"></a>
### func \(\*MockKeypair\) [Open](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L274>)

```go
func (k *MockKeypair) Open(nonce, ciphertext []byte) ([]byte, error)
```

Open decrypts ciphertext using XChaCha20\-Poly1305.

<a name="MockKeypair.PublicKey"></a>
### func \(\*MockKeypair\) [PublicKey](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L242>)

```go
func (k *MockKeypair) PublicKey() []byte
```



<a name="MockKeypair.Seal"></a>
### func \(\*MockKeypair\) [Seal](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L247>)

```go
func (k *MockKeypair) Seal(plaintext []byte) (nonce, ciphertext []byte, err error)
```

Seal encrypts plaintext using XChaCha20\-Poly1305.

<a name="MockKeypair.Sign"></a>
### func \(\*MockKeypair\) [Sign](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L238>)

```go
func (k *MockKeypair) Sign(data []byte) []byte
```



<a name="MockRuntime"></a>
## type [MockRuntime](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L20-L31>)

MockRuntime implements RuntimeInterface for testing services.

It captures emitted messages, allows delivering messages to services, and provides fake infrastructure without MQTT/mesh dependencies.

```go
type MockRuntime struct {
    Emitted []*Message // Captured Emit() calls for assertions
    // contains filtered or unexported fields
}
```

<a name="NewMockRuntime"></a>
### func [NewMockRuntime](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L34>)

```go
func NewMockRuntime(t *testing.T, name types.NaraName, id types.NaraID) *MockRuntime
```

NewMockRuntime creates a mock runtime with auto\-cleanup via t.Cleanup\(\).

<a name="MockRuntime.Clear"></a>
### func \(\*MockRuntime\) [Clear](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L217>)

```go
func (m *MockRuntime) Clear()
```

Clear clears all captured messages.

<a name="MockRuntime.Deliver"></a>
### func \(\*MockRuntime\) [Deliver](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L141>)

```go
func (m *MockRuntime) Deliver(msg *Message)
```

Deliver simulates receiving a message \(calls behavior handlers\).

Use this to test how a service reacts to incoming messages.

<a name="MockRuntime.Emit"></a>
### func \(\*MockRuntime\) [Emit](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L83>)

```go
func (m *MockRuntime) Emit(msg *Message) error
```

Emit captures messages for test assertions.

<a name="MockRuntime.EmittedCount"></a>
### func \(\*MockRuntime\) [EmittedCount](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L193>)

```go
func (m *MockRuntime) EmittedCount() int
```

EmittedCount returns the number of emitted messages.

<a name="MockRuntime.EmittedOfKind"></a>
### func \(\*MockRuntime\) [EmittedOfKind](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L206>)

```go
func (m *MockRuntime) EmittedOfKind(kind string) []*Message
```

EmittedOfKind returns all emitted messages of a given kind.

<a name="MockRuntime.Env"></a>
### func \(\*MockRuntime\) [Env](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L110>)

```go
func (m *MockRuntime) Env() Environment
```



<a name="MockRuntime.LastEmitted"></a>
### func \(\*MockRuntime\) [LastEmitted](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L198>)

```go
func (m *MockRuntime) LastEmitted() *Message
```

LastEmitted returns the most recently emitted message.

<a name="MockRuntime.Log"></a>
### func \(\*MockRuntime\) [Log](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L103>)

```go
func (m *MockRuntime) Log(service string) *ServiceLog
```



<a name="MockRuntime.LookupPublicKey"></a>
### func \(\*MockRuntime\) [LookupPublicKey](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L69>)

```go
func (m *MockRuntime) LookupPublicKey(id types.NaraID) []byte
```



<a name="MockRuntime.LookupPublicKeyByName"></a>
### func \(\*MockRuntime\) [LookupPublicKeyByName](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L73>)

```go
func (m *MockRuntime) LookupPublicKeyByName(name types.NaraName) []byte
```



<a name="MockRuntime.Me"></a>
### func \(\*MockRuntime\) [Me](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L58>)

```go
func (m *MockRuntime) Me() *Nara
```



<a name="MockRuntime.MeID"></a>
### func \(\*MockRuntime\) [MeID](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L65>)

```go
func (m *MockRuntime) MeID() types.NaraID
```



<a name="MockRuntime.MemoryMode"></a>
### func \(\*MockRuntime\) [MemoryMode](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L118>)

```go
func (m *MockRuntime) MemoryMode() string
```



<a name="MockRuntime.OnlinePeers"></a>
### func \(\*MockRuntime\) [OnlinePeers](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L114>)

```go
func (m *MockRuntime) OnlinePeers() []*PeerInfo
```



<a name="MockRuntime.Open"></a>
### func \(\*MockRuntime\) [Open](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L132>)

```go
func (m *MockRuntime) Open(nonce, ciphertext []byte) ([]byte, error)
```

Open decrypts ciphertext using the keypair.

<a name="MockRuntime.RegisterBehavior"></a>
### func \(\*MockRuntime\) [RegisterBehavior](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L180>)

```go
func (m *MockRuntime) RegisterBehavior(b *Behavior)
```

RegisterBehavior allows tests to register behaviors manually.

<a name="MockRuntime.RegisterPublicKey"></a>
### func \(\*MockRuntime\) [RegisterPublicKey](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L78>)

```go
func (m *MockRuntime) RegisterPublicKey(id types.NaraID, key []byte)
```



<a name="MockRuntime.Seal"></a>
### func \(\*MockRuntime\) [Seal](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L127>)

```go
func (m *MockRuntime) Seal(plaintext []byte) (nonce, ciphertext []byte, err error)
```

Seal encrypts plaintext using the keypair.

<a name="MockRuntime.Stop"></a>
### func \(\*MockRuntime\) [Stop](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L185>)

```go
func (m *MockRuntime) Stop()
```

Stop cleans up the mock runtime.

<a name="MockRuntime.StorageLimit"></a>
### func \(\*MockRuntime\) [StorageLimit](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L122>)

```go
func (m *MockRuntime) StorageLimit() int
```



<a name="MockRuntime.Subscribe"></a>
### func \(\*MockRuntime\) [Subscribe](<https://github.com/eljojo/nara/blob/main/runtime/mock_runtime.go#L175>)

```go
func (m *MockRuntime) Subscribe(kind string, handler func(*Message))
```

Subscribe registers a handler for a message kind.

<a name="Nara"></a>
## type [Nara](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L100-L103>)

Nara represents a network participant.

Notice there's also Nara struct in nara.go The full Nara struct will be migrated in Chapter 2.

```go
type Nara struct {
    ID   types.NaraID
    Name types.NaraName
}
```

<a name="NetworkInfoInterface"></a>
## type [NetworkInfoInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L68-L72>)

NetworkInfoInterface provides network and peer information.

```go
type NetworkInfoInterface interface {
    OnlinePeers() []*PeerInfo
    MemoryMode() string
    StorageLimit() int
}
```

<a name="NoContentKeyStage"></a>
## type [NoContentKeyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L216>)

NoContentKeyStage is a no\-op \(most messages don't need content keys\).

```go
type NoContentKeyStage struct{}
```

<a name="NoContentKeyStage.Process"></a>
### func \(\*NoContentKeyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L218>)

```go
func (s *NoContentKeyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoFilterStage"></a>
## type [NoFilterStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L152>)

NoFilterStage is a no\-op filter \(all messages pass\).

```go
type NoFilterStage struct{}
```

<a name="NoFilterStage.Process"></a>
### func \(\*NoFilterStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L154>)

```go
func (s *NoFilterStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoGossipStage"></a>
## type [NoGossipStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L99>)

NoGossipStage skips gossip \(message won't be included in zines\).

Stash uses this because stash messages are direct mesh only.

```go
type NoGossipStage struct{}
```

<a name="NoGossipStage.Process"></a>
### func \(\*NoGossipStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L101>)

```go
func (s *NoGossipStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoSignStage"></a>
## type [NoSignStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L34>)

NoSignStage skips signing \(for messages where signature is in payload or not needed\).

```go
type NoSignStage struct{}
```

<a name="NoSignStage.Process"></a>
### func \(\*NoSignStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L36>)

```go
func (s *NoSignStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoStoreStage"></a>
## type [NoStoreStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L45>)

NoStoreStage skips storage \(for ephemeral messages\).

Stash uses this because stash messages don't need to be stored in the ledger.

```go
type NoStoreStage struct{}
```

<a name="NoStoreStage.Process"></a>
### func \(\*NoStoreStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L47>)

```go
func (s *NoStoreStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoTransportStage"></a>
## type [NoTransportStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L122>)

NoTransportStage skips network transport \(local\-only messages\).

Used for service\-to\-service communication within a single nara.

```go
type NoTransportStage struct{}
```

<a name="NoTransportStage.Process"></a>
### func \(\*NoTransportStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L124>)

```go
func (s *NoTransportStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NoVerifyStage"></a>
## type [NoVerifyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L64>)

NoVerifyStage skips verification \(for unverified protocol messages or local messages\).

```go
type NoVerifyStage struct{}
```

<a name="NoVerifyStage.Process"></a>
### func \(\*NoVerifyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L66>)

```go
func (s *NoVerifyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="NotifyStage"></a>
## type [NotifyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L190>)

NotifyStage always runs last in the emit pipeline.

It notifies local subscribers that a message was emitted. This is how services can react to their own emitted messages.

```go
type NotifyStage struct{}
```

<a name="NotifyStage.Process"></a>
### func \(\*NotifyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_emit.go#L192>)

```go
func (s *NotifyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="PeerInfo"></a>
## type [PeerInfo](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L43-L47>)

PeerInfo contains information about a network peer.

```go
type PeerInfo struct {
    ID     types.NaraID
    Name   types.NaraName
    Uptime time.Duration
}
```

<a name="Personality"></a>
## type [Personality](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L90-L94>)

Personality affects filtering behavior.

```go
type Personality struct {
    Agreeableness int // 0-100
    Sociability   int // 0-100
    Chill         int // 0-100
}
```

<a name="Pipeline"></a>
## type [Pipeline](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L78>)

Pipeline chains multiple stages together.

Messages flow through stages sequentially. If any stage returns an error or drop, the pipeline stops and returns that result.

```go
type Pipeline []Stage
```

<a name="Pipeline.Run"></a>
### func \(Pipeline\) [Run](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L84>)

```go
func (p Pipeline) Run(msg *Message, ctx *PipelineContext) StageResult
```

Run executes the pipeline on a message.

Each stage processes the message in sequence. The pipeline stops early if any stage drops the message or encounters an error.

<a name="PipelineContext"></a>
## type [PipelineContext](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L64-L72>)

PipelineContext carries runtime dependencies that stages need.

Stages receive this instead of importing the full runtime, which helps avoid circular dependencies and makes testing easier.

```go
type PipelineContext struct {
    Runtime     RuntimeInterface     // For accessing runtime methods
    Ledger      LedgerInterface      // For storage stages
    Transport   TransportInterface   // For transport stages
    GossipQueue GossipQueueInterface // For gossip stages
    Keypair     KeypairInterface     // For signing stages
    Personality *Personality         // For filtering stages
    EventBus    EventBusInterface    // For notification stages
}
```

<a name="RateLimitStage"></a>
## type [RateLimitStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L102-L106>)

RateLimitStage throttles incoming messages based on a key function.

```go
type RateLimitStage struct {
    Window  time.Duration
    Max     int
    KeyFunc func(msg *Message) string
}
```

<a name="RateLimitStage.Process"></a>
### func \(\*RateLimitStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L108>)

```go
func (s *RateLimitStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="ReceiveBehavior"></a>
## type [ReceiveBehavior](<https://github.com/eljojo/nara/blob/main/runtime/behavior.go#L61-L68>)

ReceiveBehavior defines how incoming messages are processed.

```go
type ReceiveBehavior struct {
    Verify    Stage         // How to verify signature (default: DefaultVerify)
    Dedupe    Stage         // How to deduplicate (default: IDDedupe)
    RateLimit Stage         // Rate limiting (optional)
    Filter    Stage         // Personality filter (optional)
    Store     Stage         // How to store (can differ from emit!)
    OnError   ErrorStrategy // What to do on failure
}
```

<a name="Runtime"></a>
## type [Runtime](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L18-L55>)

Runtime is the core execution environment for services.

It manages message pipelines, service lifecycle, and provides primitives like logging and transport.

```go
type Runtime struct {
    // contains filtered or unexported fields
}
```

<a name="NewRuntime"></a>
### func [NewRuntime](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L71>)

```go
func NewRuntime(cfg RuntimeConfig) *Runtime
```

NewRuntime creates a new runtime with the given configuration.

<a name="Runtime.AddService"></a>
### func \(\*Runtime\) [AddService](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L498>)

```go
func (rt *Runtime) AddService(svc Service) error
```

AddService registers a service with the runtime.

<a name="Runtime.Emit"></a>
### func \(\*Runtime\) [Emit](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L189>)

```go
func (rt *Runtime) Emit(msg *Message) error
```

Emit sends a message through the emit pipeline.

<a name="Runtime.Env"></a>
### func \(\*Runtime\) [Env](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L142>)

```go
func (rt *Runtime) Env() Environment
```

Env returns the runtime environment.

<a name="Runtime.Log"></a>
### func \(\*Runtime\) [Log](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L134>)

```go
func (rt *Runtime) Log(service string) *ServiceLog
```

Log returns a logger scoped to the given service.

<a name="Runtime.LookupPublicKey"></a>
### func \(\*Runtime\) [LookupPublicKey](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L117>)

```go
func (rt *Runtime) LookupPublicKey(id types.NaraID) []byte
```

LookupPublicKey looks up a public key by nara ID.

<a name="Runtime.LookupPublicKeyByName"></a>
### func \(\*Runtime\) [LookupPublicKeyByName](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L123>)

```go
func (rt *Runtime) LookupPublicKeyByName(name types.NaraName) []byte
```

LookupPublicKeyByName looks up a public key by nara name.

<a name="Runtime.Me"></a>
### func \(\*Runtime\) [Me](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L104>)

```go
func (rt *Runtime) Me() *Nara
```

Me returns the local nara.

<a name="Runtime.MeID"></a>
### func \(\*Runtime\) [MeID](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L109>)

```go
func (rt *Runtime) MeID() types.NaraID
```

MeID returns the local nara's ID.

<a name="Runtime.MemoryMode"></a>
### func \(\*Runtime\) [MemoryMode](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L155>)

```go
func (rt *Runtime) MemoryMode() string
```

MemoryMode returns the current memory mode \(low/medium/high\).

<a name="Runtime.OnlinePeers"></a>
### func \(\*Runtime\) [OnlinePeers](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L147>)

```go
func (rt *Runtime) OnlinePeers() []*PeerInfo
```

OnlinePeers returns a list of currently online peers.

<a name="Runtime.Open"></a>
### func \(\*Runtime\) [Open](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L179>)

```go
func (rt *Runtime) Open(nonce, ciphertext []byte) ([]byte, error)
```

Open decrypts ciphertext using the runtime's keypair.

<a name="Runtime.Receive"></a>
### func \(\*Runtime\) [Receive](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L236>)

```go
func (rt *Runtime) Receive(raw []byte) error
```

Receive processes an incoming message through the receive pipeline.

<a name="Runtime.RegisterPublicKey"></a>
### func \(\*Runtime\) [RegisterPublicKey](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L129>)

```go
func (rt *Runtime) RegisterPublicKey(id types.NaraID, key []byte)
```

RegisterPublicKey registers a public key for a nara ID.

<a name="Runtime.Seal"></a>
### func \(\*Runtime\) [Seal](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L171>)

```go
func (rt *Runtime) Seal(plaintext []byte) (nonce, ciphertext []byte, err error)
```

Seal encrypts plaintext using the runtime's keypair.

<a name="Runtime.Start"></a>
### func \(\*Runtime\) [Start](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L510>)

```go
func (rt *Runtime) Start() error
```

Start starts all services.

<a name="Runtime.Stop"></a>
### func \(\*Runtime\) [Stop](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L527>)

```go
func (rt *Runtime) Stop() error
```

Stop stops all services.

<a name="Runtime.StorageLimit"></a>
### func \(\*Runtime\) [StorageLimit](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L163>)

```go
func (rt *Runtime) StorageLimit() int
```

StorageLimit returns the maximum number of stashes based on memory mode.

<a name="RuntimeConfig"></a>
## type [RuntimeConfig](<https://github.com/eljojo/nara/blob/main/runtime/runtime.go#L58-L68>)

RuntimeConfig is passed to NewRuntime.

```go
type RuntimeConfig struct {
    Me          *Nara
    Keypair     KeypairInterface
    Ledger      LedgerInterface      // Optional (nil for stash-only)
    Transport   TransportInterface   // Required
    EventBus    EventBusInterface    // Optional
    GossipQueue GossipQueueInterface // Optional (nil for stash-only)
    Personality *Personality         // Optional
    NetworkInfo NetworkInfoInterface // Optional (for peer/memory info)
    Environment Environment          // Default: EnvProduction
}
```

<a name="RuntimeInterface"></a>
## type [RuntimeInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L13-L40>)

RuntimeInterface is what services and stages can access.

This interface prevents circular dependencies and makes it easy to create mocks for testing.

```go
type RuntimeInterface interface {
    // Identity
    Me() *Nara
    MeID() types.NaraID

    // Public key management
    LookupPublicKey(id types.NaraID) []byte
    LookupPublicKeyByName(name types.NaraName) []byte
    RegisterPublicKey(id types.NaraID, key []byte)

    // Messaging
    Emit(msg *Message) error

    // Logging (runtime primitive, not a service)
    Log(service string) *ServiceLog

    // Environment
    Env() Environment

    // Network information (for automatic confidant selection)
    OnlinePeers() []*PeerInfo
    MemoryMode() string
    StorageLimit() int

    // Self-encryption (only the owner can decrypt)
    Seal(plaintext []byte) (nonce, ciphertext []byte, err error)
    Open(nonce, ciphertext []byte) ([]byte, error)
}
```

<a name="SelfAttestingVerifyStage"></a>
## type [SelfAttestingVerifyStage](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L32-L34>)

SelfAttestingVerifyStage uses public key embedded in the payload.

Used for identity announcements where the public key is in the payload itself.

```go
type SelfAttestingVerifyStage struct {
    ExtractKey func(payload any) []byte
}
```

<a name="SelfAttestingVerifyStage.Process"></a>
### func \(\*SelfAttestingVerifyStage\) [Process](<https://github.com/eljojo/nara/blob/main/runtime/stages_receive.go#L36>)

```go
func (s *SelfAttestingVerifyStage) Process(msg *Message, ctx *PipelineContext) StageResult
```



<a name="Service"></a>
## type [Service](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L155-L163>)

Service is what all services implement.

Services register with the runtime and get lifecycle callbacks.

```go
type Service interface {
    // Identity
    Name() string

    // Lifecycle
    Init(rt RuntimeInterface) error
    Start() error
    Stop() error
}
```

<a name="ServiceLog"></a>
## type [ServiceLog](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L119-L122>)

ServiceLog is a logger scoped to a specific service.

Services get this from rt.Log\("service\_name"\).

```go
type ServiceLog struct {
    // contains filtered or unexported fields
}
```

<a name="ServiceLog.Debug"></a>
### func \(\*ServiceLog\) [Debug](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L125>)

```go
func (l *ServiceLog) Debug(format string, args ...any)
```

Logger methods

<a name="ServiceLog.Error"></a>
### func \(\*ServiceLog\) [Error](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L137>)

```go
func (l *ServiceLog) Error(format string, args ...any)
```



<a name="ServiceLog.Info"></a>
### func \(\*ServiceLog\) [Info](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L129>)

```go
func (l *ServiceLog) Info(format string, args ...any)
```



<a name="ServiceLog.Warn"></a>
### func \(\*ServiceLog\) [Warn](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L133>)

```go
func (l *ServiceLog) Warn(format string, args ...any)
```



<a name="Stage"></a>
## type [Stage](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L56-L58>)

Stage processes a message and returns an explicit result.

Stages are the building blocks of message pipelines. They can:

- Transform the message \(signing, ID assignment\)
- Store it \(ledger, gossip queue\)
- Filter it \(deduplication, rate limiting, personality\)
- Transport it \(MQTT, mesh\)
- Drop it with a reason
- Fail with an error

```go
type Stage interface {
    Process(msg *Message, ctx *PipelineContext) StageResult
}
```

<a name="Casual"></a>
### func [Casual](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L133>)

```go
func Casual(filterFunc func(*Message, *Personality) bool) Stage
```

Casual returns a filter for casual importance messages \(level 1\) with a custom filter function.

<a name="ContentKey"></a>
### func [ContentKey](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L148>)

```go
func ContentKey(keyFunc func(any) string) Stage
```

ContentKey returns a stage that computes semantic identity for dedup.

<a name="ContentKeyDedupe"></a>
### func [ContentKeyDedupe](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L105>)

```go
func ContentKeyDedupe() Stage
```

ContentKeyDedupe returns a stage that deduplicates by ContentKey.

<a name="ContentKeyStore"></a>
### func [ContentKeyStore](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L37>)

```go
func ContentKeyStore(priority int) Stage
```

ContentKeyStore returns a store stage with ContentKey\-based deduplication.

<a name="Critical"></a>
### func [Critical](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L123>)

```go
func Critical() Stage
```

Critical returns a filter that never drops messages \(importance level 3\).

<a name="CustomVerify"></a>
### func [CustomVerify](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L88>)

```go
func CustomVerify(verifyFunc func(*Message, *PipelineContext) StageResult) Stage
```

CustomVerify returns a verification stage with a custom verification function.

<a name="DefaultSign"></a>
### func [DefaultSign](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L8>)

```go
func DefaultSign() Stage
```

DefaultSign returns the default signing stage.

<a name="DefaultStore"></a>
### func [DefaultStore](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L27>)

```go
func DefaultStore(priority int) Stage
```

DefaultStore returns a store stage with the given GC priority.

Priority values:

- 0: Never prune \(checkpoints, critical observations\)
- 1: Important \(hey\-there, chau\)
- 2: Normal \(social events\)
- 3: Low priority \(seen events\)
- 4: Expendable \(pings\)

<a name="DefaultVerify"></a>
### func [DefaultVerify](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L78>)

```go
func DefaultVerify() Stage
```

DefaultVerify returns the default signature verification stage.

<a name="Gossip"></a>
### func [Gossip](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L44>)

```go
func Gossip() Stage
```

Gossip returns a stage that adds the message to the gossip queue.

<a name="IDDedupe"></a>
### func [IDDedupe](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L100>)

```go
func IDDedupe() Stage
```

IDDedupe returns a stage that deduplicates by message ID.

<a name="MQTT"></a>
### func [MQTT](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L66>)

```go
func MQTT(topic string) Stage
```

MQTT returns a stage that broadcasts to a fixed MQTT topic.

<a name="MQTTPerNara"></a>
### func [MQTTPerNara](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L71>)

```go
func MQTTPerNara(pattern string) Stage
```

MQTTPerNara returns a stage that broadcasts to a per\-nara topic.

<a name="MeshOnly"></a>
### func [MeshOnly](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L61>)

```go
func MeshOnly() Stage
```

MeshOnly returns a stage that sends directly via mesh to ToID.

<a name="NoContentKey"></a>
### func [NoContentKey](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L153>)

```go
func NoContentKey() Stage
```

NoContentKey returns a no\-op content key stage.

<a name="NoFilter"></a>
### func [NoFilter](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L141>)

```go
func NoFilter() Stage
```

NoFilter returns a no\-op filter stage.

<a name="NoGossip"></a>
### func [NoGossip](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L49>)

```go
func NoGossip() Stage
```

NoGossip returns a no\-op gossip stage.

<a name="NoSign"></a>
### func [NoSign](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L13>)

```go
func NoSign() Stage
```

NoSign returns a no\-op signing stage.

<a name="NoStore"></a>
### func [NoStore](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L32>)

```go
func NoStore() Stage
```

NoStore returns a no\-op store stage \(ephemeral messages\).

<a name="NoTransport"></a>
### func [NoTransport](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L56>)

```go
func NoTransport() Stage
```

NoTransport returns a no\-op transport stage \(local\-only messages\).

<a name="NoVerify"></a>
### func [NoVerify](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L93>)

```go
func NoVerify() Stage
```

NoVerify returns a no\-op verification stage.

<a name="Normal"></a>
### func [Normal](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L128>)

```go
func Normal() Stage
```

Normal returns a filter for normal importance messages \(level 2\).

<a name="RateLimit"></a>
### func [RateLimit](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L112>)

```go
func RateLimit(window time.Duration, max int, keyFunc func(*Message) string) Stage
```

RateLimit returns a rate limiting stage.

<a name="SelfAttesting"></a>
### func [SelfAttesting](<https://github.com/eljojo/nara/blob/main/runtime/helpers.go#L83>)

```go
func SelfAttesting(extractKey func(any) []byte) Stage
```

SelfAttesting returns a verification stage that extracts the public key from the payload.

<a name="StageResult"></a>
## type [StageResult](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L6-L10>)

StageResult represents the outcome of a pipeline stage.

Every stage returns an explicit result \- no silent failures.

```go
type StageResult struct {
    Message *Message // The message to continue with (nil = dropped)
    Error   error    // Set if stage failed (transport error, validation failure, etc.)
    Reason  string   // Human-readable reason for drop ("rate_limited", "duplicate", "invalid_signature")
}
```

<a name="Continue"></a>
### func [Continue](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L15>)

```go
func Continue(msg *Message) StageResult
```

Continue indicates the message should proceed to the next stage.

<a name="Drop"></a>
### func [Drop](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L21>)

```go
func Drop(reason string) StageResult
```

Drop indicates the message was intentionally filtered/rejected. Use this for deduplication, rate limiting, personality filtering, etc.

<a name="Fail"></a>
### func [Fail](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L26>)

```go
func Fail(err error) StageResult
```

Fail indicates something went wrong \(transport failure, crypto error, etc.\).

<a name="StageResult.IsContinue"></a>
### func \(StageResult\) [IsContinue](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L33>)

```go
func (r StageResult) IsContinue() bool
```

IsContinue returns true if the result indicates continuation.

<a name="StageResult.IsDrop"></a>
### func \(StageResult\) [IsDrop](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L38>)

```go
func (r StageResult) IsDrop() bool
```

IsDrop returns true if the result indicates an intentional drop.

<a name="StageResult.IsError"></a>
### func \(StageResult\) [IsError](<https://github.com/eljojo/nara/blob/main/runtime/stage.go#L43>)

```go
func (r StageResult) IsError() bool
```

IsError returns true if the result indicates an error.

<a name="TransportInterface"></a>
## type [TransportInterface](<https://github.com/eljojo/nara/blob/main/runtime/interfaces.go#L57-L60>)

TransportInterface is what transport stages use.

```go
type TransportInterface interface {
    PublishMQTT(topic string, data []byte) error
    TrySendDirect(targetID types.NaraID, msg *Message) error
}
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
