---
title: Stash
description: API reference for the stash package
---

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# stash

```go
import "github.com/eljojo/nara/services/stash"
```

## Index

- [type EncryptedStash](<#EncryptedStash>)
- [type Service](<#Service>)
  - [func NewService\(\) \*Service](<#NewService>)
  - [func \(s \*Service\) ClearMyStash\(\)](<#Service.ClearMyStash>)
  - [func \(s \*Service\) Confidants\(\) \[\]types.NaraID](<#Service.Confidants>)
  - [func \(s \*Service\) DistributeToConfidants\(\) error](<#Service.DistributeToConfidants>)
  - [func \(s \*Service\) GetStashData\(\) \(data \[\]byte, timestamp int64\)](<#Service.GetStashData>)
  - [func \(s \*Service\) GetStoredStash\(ownerID types.NaraID\) \*EncryptedStash](<#Service.GetStoredStash>)
  - [func \(s \*Service\) HasStashData\(\) bool](<#Service.HasStashData>)
  - [func \(s \*Service\) HasStashFor\(ownerID types.NaraID\) bool](<#Service.HasStashFor>)
  - [func \(s \*Service\) Init\(rt runtime.RuntimeInterface, log \*runtime.ServiceLog\) error](<#Service.Init>)
  - [func \(s \*Service\) MarshalState\(\) \(\[\]byte, error\)](<#Service.MarshalState>)
  - [func \(s \*Service\) Name\(\) string](<#Service.Name>)
  - [func \(s \*Service\) PushTo\(ownerID types.NaraID\) error](<#Service.PushTo>)
  - [func \(s \*Service\) RecoverFromAny\(\) \(\[\]byte, error\)](<#Service.RecoverFromAny>)
  - [func \(s \*Service\) RegisterBehaviors\(rt runtime.RuntimeInterface\)](<#Service.RegisterBehaviors>)
  - [func \(s \*Service\) RequestFrom\(confidantID types.NaraID\) \(\[\]byte, error\)](<#Service.RequestFrom>)
  - [func \(s \*Service\) SelectConfidantsAutomatically\(\) error](<#Service.SelectConfidantsAutomatically>)
  - [func \(s \*Service\) SetConfidants\(confidantIDs \[\]types.NaraID\)](<#Service.SetConfidants>)
  - [func \(s \*Service\) SetStashData\(data \[\]byte\) error](<#Service.SetStashData>)
  - [func \(s \*Service\) Start\(\) error](<#Service.Start>)
  - [func \(s \*Service\) Stop\(\) error](<#Service.Stop>)
  - [func \(s \*Service\) StoreWith\(confidantID types.NaraID, data \[\]byte\) error](<#Service.StoreWith>)
  - [func \(s \*Service\) TargetConfidants\(\) int](<#Service.TargetConfidants>)
  - [func \(s \*Service\) UnmarshalState\(data \[\]byte\) error](<#Service.UnmarshalState>)


<a name="EncryptedStash"></a>
## type [EncryptedStash](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L48-L53>)

EncryptedStash is what we store for other naras.

```go
type EncryptedStash struct {
    OwnerID    types.NaraID
    Nonce      []byte
    Ciphertext []byte
    StoredAt   time.Time
}
```

<a name="Service"></a>
## type [Service](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L22-L45>)

Service implements distributed encrypted storage \(stash\).

Naras store their encrypted state with trusted peers \(confidants\) instead of on disk. Only the owner can decrypt, but confidants hold the ciphertext.

```go
type Service struct {
    // contains filtered or unexported fields
}
```

<a name="NewService"></a>
### func [NewService](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L56>)

```go
func NewService() *Service
```

NewService creates a new stash service.

<a name="Service.ClearMyStash"></a>
### func \(\*Service\) [ClearMyStash](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L400>)

```go
func (s *Service) ClearMyStash()
```

ClearMyStash clears the local stash data \(used for testing restart scenarios\).

<a name="Service.Confidants"></a>
### func \(\*Service\) [Confidants](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L238>)

```go
func (s *Service) Confidants() []types.NaraID
```



<a name="Service.DistributeToConfidants"></a>
### func \(\*Service\) [DistributeToConfidants](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L408>)

```go
func (s *Service) DistributeToConfidants() error
```

DistributeToConfidants distributes the current stash to all configured confidants.

<a name="Service.GetStashData"></a>
### func \(\*Service\) [GetStashData](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L386>)

```go
func (s *Service) GetStashData() (data []byte, timestamp int64)
```

GetStashData returns the current stash data.

<a name="Service.GetStoredStash"></a>
### func \(\*Service\) [GetStoredStash](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L475>)

```go
func (s *Service) GetStoredStash(ownerID types.NaraID) *EncryptedStash
```



<a name="Service.HasStashData"></a>
### func \(\*Service\) [HasStashData](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L393>)

```go
func (s *Service) HasStashData() bool
```

HasStashData returns true if we have stash data configured.

<a name="Service.HasStashFor"></a>
### func \(\*Service\) [HasStashFor](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L452>)

```go
func (s *Service) HasStashFor(ownerID types.NaraID) bool
```

HasStashFor returns true if we're storing a stash for the given owner.

<a name="Service.Init"></a>
### func \(\*Service\) [Init](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L72>)

```go
func (s *Service) Init(rt runtime.RuntimeInterface, log *runtime.ServiceLog) error
```



<a name="Service.MarshalState"></a>
### func \(\*Service\) [MarshalState](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L484>)

```go
func (s *Service) MarshalState() ([]byte, error)
```

MarshalState returns the service's state as JSON for persistence.

<a name="Service.Name"></a>
### func \(\*Service\) [Name](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L68>)

```go
func (s *Service) Name() string
```



<a name="Service.PushTo"></a>
### func \(\*Service\) [PushTo](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L211>)

```go
func (s *Service) PushTo(ownerID types.NaraID) error
```

Confidants returns the list of current confidants. PushTo sends the stored stash to the owner. This is used for recovery \- when we see a peer come online \(hey\-there\), we proactively send them their stash if we have it.

<a name="Service.RecoverFromAny"></a>
### func \(\*Service\) [RecoverFromAny](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L180>)

```go
func (s *Service) RecoverFromAny() ([]byte, error)
```

RecoverFromAny attempts to recover from any available confidant.

Tries all configured confidants and returns the first successful recovery.

<a name="Service.RegisterBehaviors"></a>
### func \(\*Service\) [RegisterBehaviors](<https://github.com/eljojo/nara/blob/main/services/stash/behaviors.go#L15>)

```go
func (s *Service) RegisterBehaviors(rt runtime.RuntimeInterface)
```

RegisterBehaviors registers all stash message behaviors with the runtime.

This is called during service initialization to declare how each stash message kind should be handled.

If the runtime implements BehaviorRegistry \(like MockRuntime\), behaviors are registered locally for test isolation. Otherwise, uses the global registry.

<a name="Service.RequestFrom"></a>
### func \(\*Service\) [RequestFrom](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L145>)

```go
func (s *Service) RequestFrom(confidantID types.NaraID) ([]byte, error)
```

RequestFrom requests stored data from a confidant.

Returns the decrypted data if the confidant has it, or an error.

<a name="Service.SelectConfidantsAutomatically"></a>
### func \(\*Service\) [SelectConfidantsAutomatically](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L250>)

```go
func (s *Service) SelectConfidantsAutomatically() error
```

SelectConfidantsAutomatically picks 3 confidants automatically: \- First: peer with highest uptime \- Second and third: random peers Returns error if unable to find 3 willing peers.

<a name="Service.SetConfidants"></a>
### func \(\*Service\) [SetConfidants](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L197>)

```go
func (s *Service) SetConfidants(confidantIDs []types.NaraID)
```

SetConfidants configures the list of confidants to use.

<a name="Service.SetStashData"></a>
### func \(\*Service\) [SetStashData](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L363>)

```go
func (s *Service) SetStashData(data []byte) error
```

SetStashData updates the stash data and distributes it to all confidants. If fewer than targetConfidants are configured, it automatically selects peers.

<a name="Service.Start"></a>
### func \(\*Service\) [Start](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L86>)

```go
func (s *Service) Start() error
```



<a name="Service.Stop"></a>
### func \(\*Service\) [Stop](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L91>)

```go
func (s *Service) Stop() error
```



<a name="Service.StoreWith"></a>
### func \(\*Service\) [StoreWith](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L107>)

```go
func (s *Service) StoreWith(confidantID types.NaraID, data []byte) error
```

StoreWith stores encrypted data with a confidant.

This is a synchronous call that blocks until the confidant acknowledges receipt or the request times out.

<a name="Service.TargetConfidants"></a>
### func \(\*Service\) [TargetConfidants](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L203>)

```go
func (s *Service) TargetConfidants() int
```

TargetConfidants returns the target number of confidants.

<a name="Service.UnmarshalState"></a>
### func \(\*Service\) [UnmarshalState](<https://github.com/eljojo/nara/blob/main/services/stash/service.go#L504>)

```go
func (s *Service) UnmarshalState(data []byte) error
```

UnmarshalState loads the service's state from JSON.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
