# Social Events

## Purpose

Social events capture teasing, gossip, and lightweight observations about other naras.
They provide the raw facts used to derive clout and to power the UI timeline.

## Conceptual Model

Entities:
- SocialEventPayload: the syncable social payload (Type, Actor, Target, Reason, Witness).
- SocialEvent: legacy struct used by some UI endpoints and compatibility paths.
- TeaseState: per-actor cooldown map to prevent spam.
- TeaseMessage: deterministic message template derived from reason + target.

Key invariants:
- Social events are immutable; the ledger stores them as SyncEvent entries.
- Social events can be filtered per observer based on personality.
- Tease delivery is best-effort; if direct delivery fails, gossip spreads it.
- Observations about journeys and uptime are encoded as social events of type "observation".

## External Behavior

- Teasing is generated by local heuristics (restarts, comebacks, trend changes, random).
- On receipt, social events are verified if signed and then added to the ledger only if
  the observer's personality deems them meaningful.
- Teases are DM'd directly to the target when possible; failure falls back to gossip.
- The UI consumes social events via `/events` (SSE) and via JSON endpoints.

## Interfaces

MQTT topics:
- `nara/plaza/social`: broadcasts SyncEvent with `svc="social"`.

HTTP endpoints (UI-facing):
- `GET /events`: SSE stream of UI-formatted social/presence/ping events.
- `GET /social/recent`: recent social events (converted to legacy SocialEvent form).
- `GET /social/teases`: tease counts per actor (ledger-derived).

Mesh HTTP endpoints (for direct delivery):
- `POST /dm`: delivers a signed SyncEvent; rejects unsigned or invalid signatures.

Public structs:
- `SocialEventPayload`, `SocialEvent`, `TeaseState`.

## Event Types & Schemas (if relevant)

Service: `social` (`SyncEvent.Service`).

`SocialEventPayload` fields:
- `type`: "tease", "observed", "gossip", "observation", or "service".
- `actor`: who did it.
- `target`: who it is about.
- `reason`: reason string (see list below).
- `witness`: optional reporter/metadata.

Reasons in active use:
- Tease reasons: `high-restarts`, `comeback`, `trend-abandon`, `random`, `nice-number`.
- Observation reasons: `online`, `offline`, `journey-pass`, `journey-complete`, `journey-timeout`.
- Service reasons: `stash-stored`.

Journey observations store the journey ID in `witness`.

## Algorithms

Tease gating and selection:
- `ShouldTeaseForRestarts`: compute restarts per day, compare against a personality-
  adjusted threshold (base 2/day, sociability lowers, chill/agreeableness raise).
- `ShouldTeaseForNiceNumber`: if restart count is "nice", probabilistic trigger
  using a deterministic hash of the restart count.
- `ShouldTeaseForComeback`: only when previous state was MISSING and now ONLINE,
  and sociability > 40.
- `ShouldTeaseForTrendAbandon`: only when leaving a sufficiently popular trend
  and agreeableness <= 70.
- `ShouldRandomTeaseWithBoost`: deterministic hash of soul + target + timestamp;
  base probability ~1 percent, adjusted by sociability and chill, capped at 5 percent.

Anti-pile-on:
- `TeaseWithDelay` waits a random 0-5s and aborts if a recent tease exists
  for the same target+reason in the last 30s.

Cooldown:
- `TeaseState` enforces a 5-minute cooldown per actor->target, with cleanup of
  entries older than 2x the cooldown.

Filtering by personality:
- `socialEventIsMeaningful` drops social events based on chill/sociability/agreeableness
  (e.g., very chill naras ignore random teases and routine online/offline events).

## Failure Modes

- Unsigned or invalid signatures on `/dm` are rejected.
- If the ledger is nil, events are not stored and UI counts may be empty.
- If direct delivery fails, social events still propagate by gossip and MQTT.

## Security / Trust Model (if relevant)

- Social events may be signed; signatures are verified when present.
- Mesh DM delivery requires a valid signature and a known public key.
- There is no global authority; authenticity is local signature verification.

## Test Oracle

- Tease cooldown and deterministic triggers behave as expected. (`teasing_test.go`)
- Observation social events and journey social events are constructed correctly. (`social_test.go`)
- Trend joining/leaving logic produces deterministic behavior. (`social_trend_test.go`)
- Invalid or unknown signatures are rejected for DM delivery. (`http_test.go`)

## Open Questions / TODO

- None.
